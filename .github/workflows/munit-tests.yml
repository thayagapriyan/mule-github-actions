name: Run MUnit Tests

on:
  pull_request:
    branches: [develop, main]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name to test'
        required: false
        type: string
        default: ''

jobs:
  munit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Set up JDK17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
      - name: Run MUnit Tests
        id: munit
        continue-on-error: true
        run: |
          mvn test --file pom.xml \
            -s .maven/settings.xml \
            -Dmule.client.id="${{ secrets.CONNECTED_APP_ID }}" \
            -Dmule.client.secret="${{ secrets.CONNECTED_APP_SECRET }}"
      
      # Step for SUCCESS - Show Coverage Report from JSON or fallback to txt files
      - name: MUnit Summary (Success)
        if: steps.munit.outcome == 'success'
        run: |
          COVERAGE_FILE="target/site/munit/coverage/munit-coverage.json"
          REPORT_DIR="target/surefire-reports"
          
          echo "## âœ… MUnit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Try JSON coverage file first
          if [ -f "$COVERAGE_FILE" ]; then
            COVERAGE=$(jq -r '.coverage' "$COVERAGE_FILE")
            COVERAGE_FMT=$(printf "%.2f" $COVERAGE)
            
            echo "### ðŸŽ¯ Application Coverage: **${COVERAGE_FMT}%**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Process each resource file
            for i in $(jq -r '.files | keys[]' "$COVERAGE_FILE"); do
              FILE_NAME=$(jq -r ".files[$i].name" "$COVERAGE_FILE")
              FILE_COVERAGE=$(jq -r ".files[$i].coverage" "$COVERAGE_FILE")
              FILE_COVERAGE_FMT=$(printf "%.2f" $FILE_COVERAGE)
              
              echo "#### ðŸ“ \`$FILE_NAME\` - Coverage: ${FILE_COVERAGE_FMT}%" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "| Name | Type | Covered | Total | Coverage |" >> $GITHUB_STEP_SUMMARY
              echo "|:-----|:-----|--------:|------:|---------:|" >> $GITHUB_STEP_SUMMARY
              
              for j in $(jq -r ".files[$i].flows | keys[]" "$COVERAGE_FILE"); do
                FLOW_NAME=$(jq -r ".files[$i].flows[$j].name" "$COVERAGE_FILE")
                FLOW_TYPE=$(jq -r ".files[$i].flows[$j].type" "$COVERAGE_FILE")
                FLOW_COVERAGE=$(jq -r ".files[$i].flows[$j].coverage" "$COVERAGE_FILE")
                FLOW_TOTAL=$(jq -r ".files[$i].flows[$j].messageProcessorCount" "$COVERAGE_FILE")
                FLOW_COVERED=$(jq -r ".files[$i].flows[$j].coveredProcessorCount" "$COVERAGE_FILE")
                FLOW_COVERAGE_FMT=$(printf "%.2f" $FLOW_COVERAGE)
                
                case "$FLOW_TYPE" in
                  "FLOW") TYPE_DISPLAY="Flow" ;;
                  "SUB_FLOW") TYPE_DISPLAY="Sub flow" ;;
                  "ERROR_HANDLER") TYPE_DISPLAY="Error handler" ;;
                  *) TYPE_DISPLAY="$FLOW_TYPE" ;;
                esac
                
                echo "| \`$FLOW_NAME\` | $TYPE_DISPLAY | $FLOW_COVERED | $FLOW_TOTAL | ${FLOW_COVERAGE_FMT}% |" >> $GITHUB_STEP_SUMMARY
              done
              echo "" >> $GITHUB_STEP_SUMMARY
            done
          
          # Fallback to txt files if JSON not available
          elif [ -d "$REPORT_DIR" ]; then
            echo "### ðŸ“ Test Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| # | Test Name | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|--:|:----------|:------:|" >> $GITHUB_STEP_SUMMARY
            
            COUNT=1
            for report in $REPORT_DIR/*.txt; do
              if [ -f "$report" ]; then
                while IFS= read -r line; do
                  if [[ "$line" == SUCCESS* ]]; then
                    TEST_NAME=$(echo "$line" | sed 's/SUCCESS - Test //' | sed 's/ finished Successfully\.//')
                    echo "| $COUNT | \`$TEST_NAME\` | âœ… |" >> $GITHUB_STEP_SUMMARY
                    COUNT=$((COUNT + 1))
                  fi
                done < "$report"
              fi
            done
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:---------|:------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Branch | \`$GITHUB_REF_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ Triggered By | @$GITHUB_ACTOR |" >> $GITHUB_STEP_SUMMARY
      
      # Step for FAILURE - Show test results from txt files
      - name: MUnit Summary (Failure)
        if: steps.munit.outcome == 'failure'
        run: |
          REPORT_DIR="target/surefire-reports"
          
          echo "## âŒ MUnit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| # | Test Name | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--:|:----------|:------:|" >> $GITHUB_STEP_SUMMARY
          
          COUNT=1
          if [ -d "$REPORT_DIR" ]; then
            for report in $REPORT_DIR/*.txt; do
              if [ -f "$report" ]; then
                while IFS= read -r line; do
                  if [[ "$line" == SUCCESS* ]]; then
                    TEST_NAME=$(echo "$line" | sed 's/SUCCESS - Test //' | sed 's/ finished Successfully\.//')
                    echo "| $COUNT | \`$TEST_NAME\` | âœ… |" >> $GITHUB_STEP_SUMMARY
                    COUNT=$((COUNT + 1))
                  elif [[ "$line" == FAILURE* ]] || [[ "$line" == ERROR* ]]; then
                    TEST_NAME=$(echo "$line" | sed 's/\(FAILURE\|ERROR\) - Test //' | sed 's/ .*//')
                    echo "| $COUNT | \`$TEST_NAME\` | âŒ |" >> $GITHUB_STEP_SUMMARY
                    COUNT=$((COUNT + 1))
                  fi
                done < "$report"
              fi
            done
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:---------|:------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Branch | \`$GITHUB_REF_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ Triggered By | @$GITHUB_ACTOR |" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: munit-reports
          path: |
            target/site/munit/coverage/
            target/surefire-reports/*.txt
          if-no-files-found: ignore
      
      - name: Fail if tests failed
        if: steps.munit.outcome == 'failure'
        run: exit 1
