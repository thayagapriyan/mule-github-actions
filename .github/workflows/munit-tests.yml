name: Run MUnit Tests

on:
  pull_request:
    branches: [develop, main]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name to test'
        required: false
        type: string
        default: ''

jobs:
  munit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Set up JDK17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
      - name: Run MUnit Tests
        id: munit
        continue-on-error: true
        run: |
          mvn test --file pom.xml \
            -s .maven/settings.xml \
            -Dmule.client.id="${{ secrets.CONNECTED_APP_ID }}" \
            -Dmule.client.secret="${{ secrets.CONNECTED_APP_SECRET }}"
      - name: Create Test Summary
        if: always()
        run: |
          REPORT_DIR="target/surefire-reports"
          
          echo "## ðŸ§ª MUnit Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| # | Test Name |" >> $GITHUB_STEP_SUMMARY
          echo "|--:|:----------|" >> $GITHUB_STEP_SUMMARY
          
          COUNT=1
          HAS_FAILURES=false
          
          if [ -d "$REPORT_DIR" ]; then
            for report in $REPORT_DIR/*.txt; do
              if [ -f "$report" ]; then
                while IFS= read -r line; do
                  if [[ "$line" == SUCCESS* ]]; then
                    TEST_NAME=$(echo "$line" | sed 's/SUCCESS - Test //' | sed 's/ finished Successfully\.//')
                    echo "| $COUNT | âœ… \`$TEST_NAME\` |" >> $GITHUB_STEP_SUMMARY
                    COUNT=$((COUNT + 1))
                  elif [[ "$line" == FAILURE* ]] || [[ "$line" == ERROR* ]]; then
                    TEST_NAME=$(echo "$line" | sed 's/\(FAILURE\|ERROR\) - Test //' | sed 's/ .*//')
                    echo "| $COUNT | âŒ \`$TEST_NAME\` |" >> $GITHUB_STEP_SUMMARY
                    COUNT=$((COUNT + 1))
                    HAS_FAILURES=true
                  fi
                done < "$report"
              fi
            done
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|:---------|:------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Branch | \`$GITHUB_REF_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ Triggered By | @$GITHUB_ACTOR |" >> $GITHUB_STEP_SUMMARY
          
          if [ "$HAS_FAILURES" = true ]; then
            exit 1
          fi
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: munit-reports
          path: target/surefire-reports/*.txt
          if-no-files-found: ignore
