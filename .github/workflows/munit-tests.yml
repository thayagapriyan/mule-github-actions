name: Run MUnit Tests

on:
  pull_request:
    branches: [develop, main]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name to test'
        required: false
        type: string
        default: ''

jobs:
  munit-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Set up JDK17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: 17
      - name: Run MUnit Tests
        id: munit
        continue-on-error: true
        run: |
          mvn test --file pom.xml \
            -s .maven/settings.xml \
            -Dmule.client.id="${{ secrets.CONNECTED_APP_ID }}" \
            -Dmule.client.secret="${{ secrets.CONNECTED_APP_SECRET }}"
      
      - name: MUnit Summary
        if: always()
        run: |
          REPORT_DIR="target/surefire-reports"
          SUCCESS_COUNT=0
          FAILED_COUNT=0
          
          echo "## ðŸ§ª MUnit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| # | Test Name | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--:|:----------|:------:|" >> $GITHUB_STEP_SUMMARY
          
          COUNT=1
          if [ -d "$REPORT_DIR" ]; then
            for report in $REPORT_DIR/*.txt; do
              if [ -f "$report" ]; then
                while IFS= read -r line; do
                  if [[ "$line" == SUCCESS* ]]; then
                    TEST_NAME=$(echo "$line" | sed 's/SUCCESS - Test //' | sed 's/ finished Successfully\.//')
                    echo "| $COUNT | \`$TEST_NAME\` | âœ… |" >> $GITHUB_STEP_SUMMARY
                    COUNT=$((COUNT + 1))
                    SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                  elif [[ "$line" == FAILURE* ]] || [[ "$line" == ERROR* ]]; then
                    TEST_NAME=$(echo "$line" | sed 's/\(FAILURE\|ERROR\) - Test //' | sed 's/ .*//')
                    echo "| $COUNT | \`$TEST_NAME\` | âŒ |" >> $GITHUB_STEP_SUMMARY
                    COUNT=$((COUNT + 1))
                    FAILED_COUNT=$((FAILED_COUNT + 1))
                  fi
                done < "$report"
              fi
            done
          fi
          
          TOTAL=$((SUCCESS_COUNT + FAILED_COUNT))
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|:-------|------:|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Success | **$SUCCESS_COUNT** |" >> $GITHUB_STEP_SUMMARY
          echo "| âŒ Failed | **$FAILED_COUNT** |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Total | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ Branch | \`$GITHUB_REF_NAME\` |" >> $GITHUB_STEP_SUMMARY
          echo "|:---------|:------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Commit | \`${GITHUB_SHA::7}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ Triggered By | @$GITHUB_ACTOR |" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: munit-reports
          path: target/surefire-reports/*.txt
          if-no-files-found: ignore
      
      - name: Fail if tests failed
        if: steps.munit.outcome == 'failure'
        run: exit 1
